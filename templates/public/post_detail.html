{% extends "public/base.html" %}

{% block title %}{{ post.title }} - My Blog{% endblock %}

{% block extra_css %}
<meta property="og:title" content="{{ post.title }}">
<meta property="og:description" content="{{ post.content[:200]|striptags }}">
{% if post.first_image %}
<meta property="og:image" content="{{ url_for('static', filename='uploads/' + post.first_image.filename, _external=True) }}">
{% elif post.thumbnail %}
<meta property="og:image" content="{{ url_for('static', filename='uploads/' + post.thumbnail, _external=True) }}">
{% endif %}

<style>
/* LinkedIn-style Media Carousel */
.media-carousel-container {
    position: relative;
    background: #000;
    border-radius: 8px 8px 0 0;
    overflow: hidden;
}

.media-carousel {
    position: relative;
    width: 100%;
    overflow: hidden;
}

.media-carousel-track {
    display: flex;
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    touch-action: pan-y pinch-zoom;
}

.media-carousel-slide {
    flex: 0 0 100%;
    min-width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
    position: relative;
}

.media-carousel-slide img {
    max-width: 100%;
    max-height: 600px;
    width: auto;
    height: auto;
    object-fit: contain;
}

.media-carousel-slide video {
    max-width: 100%;
    max-height: 600px;
    width: 100%;
}

/* Navigation Arrows */
.carousel-nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.95);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: #333;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    transition: all 0.2s;
    opacity: 0;
}

.media-carousel-container:hover .carousel-nav-btn {
    opacity: 1;
}

.carousel-nav-btn:hover {
    background: #fff;
    transform: translateY(-50%) scale(1.1);
}

.carousel-nav-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.carousel-nav-prev {
    left: 16px;
}

.carousel-nav-next {
    right: 16px;
}

/* Dots Indicator */
.carousel-dots {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
    z-index: 10;
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 20px;
}

.carousel-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    border: none;
    cursor: pointer;
    transition: all 0.3s;
    padding: 0;
}

.carousel-dot.active {
    background: #fff;
    transform: scale(1.2);
}

.carousel-dot:hover:not(.active) {
    background: rgba(255, 255, 255, 0.8);
}

/* Counter Badge */
.carousel-counter {
    position: absolute;
    top: 16px;
    right: 16px;
    background: rgba(0, 0, 0, 0.7);
    color: #fff;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    z-index: 10;
}

/* Fullscreen Button */
.carousel-fullscreen-btn {
    position: absolute;
    top: 16px;
    left: 16px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.7);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 14px;
    z-index: 10;
    transition: all 0.2s;
}

.carousel-fullscreen-btn:hover {
    background: rgba(0, 0, 0, 0.9);
    transform: scale(1.1);
}

/* Media Type Badge */
.media-type-indicator {
    position: absolute;
    bottom: 16px;
    left: 16px;
    background: rgba(0, 0, 0, 0.7);
    color: #fff;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    text-transform: uppercase;
    z-index: 10;
}

/* Video Play Overlay */
.video-play-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.3);
    cursor: pointer;
    transition: background 0.2s;
}

.video-play-overlay:hover {
    background: rgba(0, 0, 0, 0.5);
}

.video-play-overlay i {
    font-size: 64px;
    color: #fff;
    text-shadow: 0 2px 12px rgba(0,0,0,0.5);
    transition: transform 0.2s;
}

.video-play-overlay:hover i {
    transform: scale(1.1);
}

.video-play-overlay.hidden {
    display: none;
}

/* Touch/Swipe Indicator */
.swipe-hint {
    position: absolute;
    bottom: 60px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.7);
    color: #fff;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    z-index: 10;
    animation: fadeOut 3s forwards;
    animation-delay: 2s;
}

@keyframes fadeOut {
    to {
        opacity: 0;
        visibility: hidden;
    }
}

/* Fullscreen Mode */
.fullscreen-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
}

.fullscreen-modal.active {
    opacity: 1;
    visibility: visible;
}

.fullscreen-modal .media-carousel-slide img,
.fullscreen-modal .media-carousel-slide video {
    max-height: 90vh;
}

.fullscreen-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 20px;
    z-index: 10;
    transition: all 0.2s;
}

.fullscreen-close:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Responsive */
@media (max-width: 768px) {
    .carousel-nav-btn {
        width: 36px;
        height: 36px;
        font-size: 14px;
        opacity: 1;
    }
    
    .carousel-nav-prev {
        left: 8px;
    }
    
    .carousel-nav-next {
        right: 8px;
    }
    
    .media-carousel-slide img,
    .media-carousel-slide video {
        max-height: 400px;
    }
    
    .carousel-counter {
        top: 10px;
        right: 10px;
        padding: 4px 10px;
        font-size: 12px;
    }
    
    .video-play-overlay i {
        font-size: 48px;
    }
}

/* Single Image (no carousel needed) */
.single-media-display {
    border-radius: 8px 8px 0 0;
    overflow: hidden;
    background: #000;
}

.single-media-display img {
    width: 100%;
    max-height: 600px;
    object-fit: contain;
}

.single-media-display video {
    width: 100%;
    max-height: 600px;
}

/* Grid Layout for 2-4 images (LinkedIn style) */
.media-grid {
    display: grid;
    gap: 2px;
    background: #000;
    border-radius: 8px 8px 0 0;
    overflow: hidden;
}

.media-grid.grid-2 {
    grid-template-columns: repeat(2, 1fr);
}

.media-grid.grid-3 {
    grid-template-columns: 2fr 1fr;
    grid-template-rows: repeat(2, 200px);
}

.media-grid.grid-3 .grid-item:first-child {
    grid-row: span 2;
}

.media-grid.grid-4 {
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(2, 200px);
}

.grid-item {
    position: relative;
    overflow: hidden;
    cursor: pointer;
    transition: opacity 0.2s;
}

.grid-item:hover {
    opacity: 0.9;
}

.grid-item img,
.grid-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.grid-item .more-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 24px;
    font-weight: 600;
}

/* Full-width post layout */
.post-content-body {
    max-width: 100%;
    line-height: 1.8;
}

.post-content-body img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
}

/* Responsive adjustments for full-width */
@media (min-width: 1200px) {
    .container-fluid.px-md-5 {
        padding-left: 8% !important;
        padding-right: 8% !important;
    }
}

@media (min-width: 1600px) {
    .container-fluid.px-md-5 {
        padding-left: 12% !important;
        padding-right: 12% !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-5 my-4">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <article class="card shadow-sm">
                <!-- LinkedIn-style Media Display -->
                {% if post.media %}
                    {% set media_count = post.media|length %}
                    
                    {% if media_count == 1 %}
                        <!-- Single Media -->
                        {% set media = post.media[0] %}
                        <div class="single-media-display" onclick="openFullscreen(0)">
                            {% if media.media_type == 'image' %}
                            <img src="{{ url_for('static', filename='uploads/' + media.filename) }}" 
                                 alt="{{ post.title }}" loading="lazy">
                            {% else %}
                            <div style="position: relative;">
                                <video id="video-0" class="post-video" controls playsinline>
                                    <source src="{{ url_for('static', filename='uploads/' + media.filename) }}" 
                                            type="video/{{ media.filename.split('.')[-1] }}">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                            {% endif %}
                        </div>
                    
                    {% elif media_count >= 2 %}
                        <!-- Carousel for multiple media -->
                        <div class="media-carousel-container" id="mediaCarousel">
                            <div class="media-carousel">
                                <div class="media-carousel-track" id="carouselTrack">
                                    {% for media in post.media %}
                                    <div class="media-carousel-slide" data-index="{{ loop.index0 }}">
                                        {% if media.media_type == 'image' %}
                                        <img src="{{ url_for('static', filename='uploads/' + media.filename) }}" 
                                             alt="{{ post.title }} - Image {{ loop.index }}" 
                                             loading="lazy"
                                             onclick="openFullscreen({{ loop.index0 }})">
                                        {% else %}
                                        <div style="position: relative; width: 100%;">
                                            <video id="video-{{ loop.index0 }}" class="post-video" controls playsinline>
                                                <source src="{{ url_for('static', filename='uploads/' + media.filename) }}" 
                                                        type="video/{{ media.filename.split('.')[-1] }}">
                                            </video>
                                            <div class="video-play-overlay" onclick="playVideo({{ loop.index0 }})">
                                                <i class="fas fa-play-circle"></i>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Navigation Arrows -->
                            <button class="carousel-nav-btn carousel-nav-prev" onclick="prevSlide()" aria-label="Previous">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="carousel-nav-btn carousel-nav-next" onclick="nextSlide()" aria-label="Next">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            
                            <!-- Counter -->
                            <div class="carousel-counter">
                                <span id="currentSlide">1</span> / {{ media_count }}
                            </div>
                            
                            <!-- Fullscreen Button -->
                            <button class="carousel-fullscreen-btn" onclick="openFullscreen(currentIndex)" aria-label="Fullscreen">
                                <i class="fas fa-expand"></i>
                            </button>
                            
                            <!-- Dots -->
                            <div class="carousel-dots">
                                {% for media in post.media %}
                                <button class="carousel-dot{% if loop.index0 == 0 %} active{% endif %}" 
                                        onclick="goToSlide({{ loop.index0 }})"
                                        aria-label="Go to slide {{ loop.index }}"></button>
                                {% endfor %}
                            </div>
                            
                            <!-- Touch Hint (mobile) -->
                            <div class="swipe-hint d-md-none">
                                <i class="fas fa-hand-point-left me-1"></i> Swipe to see more
                            </div>
                        </div>
                    {% endif %}
                    
                {% elif post.thumbnail %}
                <!-- Fallback to old thumbnail for backward compatibility -->
                <img src="{{ url_for('static', filename='uploads/' + post.thumbnail) }}" 
                     class="card-img-top" alt="{{ post.title }}" style="max-height: 500px; object-fit: contain;">
                {% endif %}
                
                <div class="card-body">
                    <h1 class="card-title">{{ post.title }}</h1>
                    <div class="text-muted mb-3">
                        <i class="fas fa-calendar"></i> {{ post.created_at.strftime('%B %d, %Y') }}
                        {% if post.category %}
                        | <a href="{{ url_for('public.category_posts', category_id=post.category.id) }}" class="text-decoration-none">
                            <i class="fas fa-folder"></i> {{ post.category.name }}
                        </a>
                        {% endif %}
                        {% if post.tags %}
                        | <span>
                            {% for tag in post.tags %}
                            <a href="{{ url_for('public.tag_posts', tag_id=tag.id) }}" class="badge bg-secondary text-decoration-none">
                                {{ tag.name }}
                            </a>
                            {% endfor %}
                        </span>
                        {% endif %}
                    </div>
                    <div class="card-text">
                        {{ post.content|safe }}
                    </div>
                    
                    <!-- Facebook-style Interaction Bar -->
                    <div class="post-interactions mt-4 pt-3 border-top">
                        <!-- Reactions Summary -->
                        {% if post.likes_count > 0 %}
                        <div class="reactions-summary mb-2">
                            <div class="d-flex align-items-center">
                                <span class="reaction-icons me-2">
                                    <i class="fas fa-thumbs-up text-primary"></i>
                                    <i class="fas fa-heart text-danger"></i>
                                </span>
                                <span class="text-muted small" id="reactionsText">
                                    {% if post.likes_count == 1 %}
                                        1 person
                                    {% else %}
                                        {{ post.likes_count }} people
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Action Buttons -->
                        <div class="action-buttons d-flex justify-content-between align-items-center border-top border-bottom py-2">
                            <button id="likeBtn" class="action-btn like-action-btn {% if is_post_liked %}liked{% endif %}" 
                                    data-post-id="{{ post.id }}"
                                    data-login-url="{{ url_for('public.login', next=request.url) }}">
                                <i class="{% if is_post_liked %}fas{% else %}far{% endif %} fa-thumbs-up"></i> <span>Like</span>
                            </button>
                            <button class="action-btn comment-action-btn" 
                                    {% if not current_user.is_authenticated or session.get('user_type') != 'user' %}
                                    onclick="redirectToLogin('{{ url_for('public.login', next=request.url) }}')"
                                    {% else %}
                                    onclick="document.querySelector('.comment-form textarea').focus()"
                                    {% endif %}>
                                <i class="far fa-comment"></i> <span>Comment</span>
                            </button>
                            <button class="action-btn share-action-btn" onclick="sharePost()">
                                <i class="far fa-share-square"></i> <span>Share</span>
                            </button>
                        </div>
                        
                        <!-- Comments Count -->
                        <div class="comments-header mt-2">
                            <span class="text-muted small" id="commentsCountText">
                                {% if post.comments_count == 0 %}
                                    No comments yet
                                {% elif post.comments_count == 1 %}
                                    1 comment
                                {% else %}
                                    {{ post.comments_count }} comments
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </article>
            
            <!-- Comments Section -->
            <div class="comments-section mt-3">
                <!-- Comment Form -->
                {% if current_user.is_authenticated and session.get('user_type') == 'user' %}
                <div class="comment-form mb-3">
                    <form method="POST" action="{{ url_for('public.add_comment', post_id=post.id) }}" class="d-flex align-items-start gap-2" id="main-comment-form" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}
                        {{ form.parent_comment_id(value="") }}
                        <div class="avatar-circle avatar-sm">
                            <span class="avatar-text">{{ get_avatar_initials(current_user.full_name or current_user.username) }}</span>
                        </div>
                        <div class="flex-grow-1">
                            <div class="comment-input-wrapper">
                                {{ form.comment(class="form-control comment-input", rows="1", placeholder="Write a comment...") }}
                                {% for error in form.comment.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>
                            <div class="comment-image-preview" id="main-image-preview" style="display: none;">
                                <img src="" alt="Preview" class="preview-img">
                                <button type="button" class="remove-image-btn" onclick="removeImagePreview('main')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="comment-actions mt-2" style="display: none;">
                                <label class="btn btn-sm btn-outline-secondary image-upload-btn me-2" title="Add image">
                                    <i class="fas fa-image"></i>
                                    <input type="file" name="image" accept="image/*" class="image-input" 
                                           onchange="previewImage(this, 'main')" style="display: none;">
                                </label>
                                <button type="submit" class="btn btn-sm btn-primary">Post</button>
                                <button type="button" class="btn btn-sm btn-secondary cancel-comment-btn">Cancel</button>
                            </div>
                        </div>
                    </form>
                </div>
                {% else %}
                <div class="comment-form mb-3">
                    <div class="d-flex align-items-start gap-2">
                        <div class="avatar-circle avatar-sm">
                            <span class="avatar-text">?</span>
                        </div>
                        <div class="flex-grow-1">
                            <div class="comment-input-wrapper">
                                <input type="text" class="form-control comment-input" rows="1" 
                                       placeholder="Write a comment..." readonly
                                       onclick="redirectToLogin('{{ url_for('public.login', next=request.url) }}')"
                                       style="cursor: pointer;">
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- View More Comments Link -->
                {% if top_level_comments|length > 3 %}
                <div class="view-more-comments mb-2">
                    <a href="#" class="text-decoration-none text-primary small" id="viewMoreComments">
                        View more comments
                    </a>
                </div>
                {% endif %}
                
                <!-- Comments List -->
                <div id="comments-container">
                    {% if top_level_comments %}
                        {% for comment in top_level_comments[:3] %}
                            {% set depth = 0 %}
                            {% set max_depth = 10 %}
                            {% include 'public/_comment.html' %}
                        {% endfor %}
                        {% if top_level_comments|length > 3 %}
                            <div id="hidden-comments" style="display: none;">
                                {% for comment in top_level_comments[3:] %}
                                    {% set depth = 0 %}
                                    {% set max_depth = 10 %}
                                    {% include 'public/_comment.html' %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% else %}
                        <p class="text-muted small text-center py-3">No comments yet. Be the first to comment!</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Related Posts -->
            {% if related_posts %}
            <div class="card mt-4 shadow-sm">
                <div class="card-header">
                    <h5>Related Posts</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for related_post in related_posts %}
                        <div class="col-md-4 mb-3">
                            <a href="{{ url_for('public.post_detail', slug=related_post.slug) }}" class="text-decoration-none">
                                <h6>{{ related_post.title }}</h6>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Fullscreen Modal -->
<div class="fullscreen-modal" id="fullscreenModal">
    <button class="fullscreen-close" onclick="closeFullscreen()">
        <i class="fas fa-times"></i>
    </button>
    <div class="media-carousel-container" style="width: 90%; max-width: 1200px;">
        <div class="media-carousel">
            <div class="media-carousel-track" id="fullscreenTrack">
                {% for media in post.media %}
                <div class="media-carousel-slide" data-index="{{ loop.index0 }}">
                    {% if media.media_type == 'image' %}
                    <img src="{{ url_for('static', filename='uploads/' + media.filename) }}" 
                         alt="{{ post.title }} - Image {{ loop.index }}" loading="lazy">
                    {% else %}
                    <video controls playsinline>
                        <source src="{{ url_for('static', filename='uploads/' + media.filename) }}" 
                                type="video/{{ media.filename.split('.')[-1] }}">
                    </video>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <button class="carousel-nav-btn carousel-nav-prev" onclick="prevSlide(true)" aria-label="Previous" style="opacity: 1;">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button class="carousel-nav-btn carousel-nav-next" onclick="nextSlide(true)" aria-label="Next" style="opacity: 1;">
            <i class="fas fa-chevron-right"></i>
        </button>
        
        <div class="carousel-counter">
            <span id="fullscreenCurrentSlide">1</span> / {{ post.media|length }}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============== Media Carousel ==============
let currentIndex = 0;
const totalSlides = {{ post.media|length if post.media else 0 }};
const track = document.getElementById('carouselTrack');
const fullscreenTrack = document.getElementById('fullscreenTrack');
const fullscreenModal = document.getElementById('fullscreenModal');

// Update slide position
function updateSlide(isFullscreen = false) {
    const targetTrack = isFullscreen ? fullscreenTrack : track;
    if (!targetTrack) return;
    
    targetTrack.style.transform = `translateX(-${currentIndex * 100}%)`;
    
    // Update counter
    const counter = document.getElementById(isFullscreen ? 'fullscreenCurrentSlide' : 'currentSlide');
    if (counter) counter.textContent = currentIndex + 1;
    
    // Update dots
    const dots = document.querySelectorAll('.carousel-dot');
    dots.forEach((dot, idx) => {
        dot.classList.toggle('active', idx === currentIndex);
    });
    
    // Pause all videos except current
    document.querySelectorAll('.post-video').forEach((video, idx) => {
        if (idx !== currentIndex) {
            video.pause();
        }
    });
}

// Navigation
function nextSlide(isFullscreen = false) {
    if (currentIndex < totalSlides - 1) {
        currentIndex++;
        updateSlide(isFullscreen);
    }
}

function prevSlide(isFullscreen = false) {
    if (currentIndex > 0) {
        currentIndex--;
        updateSlide(isFullscreen);
    }
}

function goToSlide(index) {
    currentIndex = index;
    updateSlide();
}

// Video play handler
function playVideo(index) {
    const video = document.getElementById(`video-${index}`);
    const overlay = video.parentElement.querySelector('.video-play-overlay');
    
    if (video && overlay) {
        overlay.classList.add('hidden');
        video.play();
    }
}

// Fullscreen mode
function openFullscreen(index) {
    currentIndex = index;
    updateSlide(true);
    fullscreenModal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeFullscreen() {
    fullscreenModal.classList.remove('active');
    document.body.style.overflow = '';
    updateSlide(false);
}

// Touch/Swipe support
let touchStartX = 0;
let touchEndX = 0;
let isSwiping = false;

if (track) {
    track.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        isSwiping = true;
    }, { passive: true });
    
    track.addEventListener('touchmove', (e) => {
        if (!isSwiping) return;
        touchEndX = e.changedTouches[0].screenX;
    }, { passive: true });
    
    track.addEventListener('touchend', () => {
        if (!isSwiping) return;
        isSwiping = false;
        
        const diff = touchStartX - touchEndX;
        const threshold = 50;
        
        if (diff > threshold) {
            nextSlide();
        } else if (diff < -threshold) {
            prevSlide();
        }
    });
}

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (fullscreenModal.classList.contains('active')) {
        if (e.key === 'ArrowLeft') prevSlide(true);
        else if (e.key === 'ArrowRight') nextSlide(true);
        else if (e.key === 'Escape') closeFullscreen();
    } else {
        if (e.key === 'ArrowLeft') prevSlide();
        else if (e.key === 'ArrowRight') nextSlide();
    }
});

// Close fullscreen on overlay click
fullscreenModal?.addEventListener('click', (e) => {
    if (e.target === fullscreenModal) {
        closeFullscreen();
    }
});

// ============== Comment & Like Functionality ==============

// Redirect to login function
function redirectToLogin(loginUrl) {
    Swal.fire({
        icon: 'info',
        title: 'Login Required',
        text: 'Please login to like, comment, or interact with posts.',
        showCancelButton: true,
        confirmButtonText: 'Login',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = loginUrl;
        }
    });
}

// Post like functionality
document.addEventListener('DOMContentLoaded', function() {
    const likeBtn = document.getElementById('likeBtn');
    if (likeBtn) {
        likeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const postId = this.getAttribute('data-post-id');
            const btn = this;
            const reactionsText = document.getElementById('reactionsText');
            const reactionsContainer = reactionsText ? reactionsText.parentElement : null;
            const loginUrl = btn.getAttribute('data-login-url');
            
            fetch(`/post/${postId}/like`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (response.status === 401) {
                    return response.json().then(data => {
                        if (data.redirect) {
                            redirectToLogin(data.redirect);
                        } else if (loginUrl) {
                            redirectToLogin(loginUrl);
                        } else {
                            redirectToLogin('/login');
                        }
                        throw new Error('Unauthorized');
                    });
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    const count = data.likes_count || 0;
                    if (reactionsText) {
                        reactionsText.textContent = count === 1 ? '1 person' : count + ' people';
                    }
                    if (reactionsContainer) {
                        if (count === 0) {
                            reactionsContainer.style.display = 'none';
                        } else {
                            reactionsContainer.style.display = 'flex';
                        }
                    }
                    
                    const icon = btn.querySelector('i');
                    if (icon) {
                        if (data.liked) {
                            icon.classList.remove('far');
                            icon.classList.add('fas');
                            btn.classList.add('liked');
                        } else {
                            icon.classList.remove('fas');
                            icon.classList.add('far');
                            btn.classList.remove('liked');
                        }
                    }
                } else {
                    console.error('Unexpected response:', data);
                }
            })
            .catch(error => {
                console.error('Error liking post:', error);
            });
        });
    }
});

// Comment input focus handler
document.addEventListener('DOMContentLoaded', function() {
    const commentInput = document.querySelector('.comment-form .comment-input');
    const commentActions = document.querySelector('.comment-form .comment-actions');
    const nameInput = document.querySelector('.comment-form input[name="name"]');
    
    if (commentInput) {
        commentInput.addEventListener('focus', function() {
            if (nameInput) nameInput.style.display = 'block';
            if (commentActions) commentActions.style.display = 'flex';
            this.rows = 3;
        });
        
        commentInput.addEventListener('blur', function() {
            if (!this.value.trim()) {
                if (nameInput) nameInput.style.display = 'none';
                if (commentActions) commentActions.style.display = 'none';
                this.rows = 1;
            }
        });
    }
    
    // Cancel comment button
    const cancelBtn = document.querySelector('.cancel-comment-btn');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            if (commentInput) {
                commentInput.value = '';
                commentInput.rows = 1;
            }
            if (nameInput) {
                nameInput.value = '';
                nameInput.style.display = 'none';
            }
            if (commentActions) commentActions.style.display = 'none';
        });
    }
    
    // View more comments
    const viewMoreLink = document.getElementById('viewMoreComments');
    const hiddenComments = document.getElementById('hidden-comments');
    if (viewMoreLink && hiddenComments) {
        viewMoreLink.addEventListener('click', function(e) {
            e.preventDefault();
            hiddenComments.style.display = 'block';
            this.style.display = 'none';
        });
    }
});

// Share post function
function sharePost() {
    if (navigator.share) {
        navigator.share({
            title: '{{ post.title }}',
            text: '{{ post.content[:100]|striptags }}',
            url: window.location.href
        }).catch(console.error);
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(window.location.href).then(() => {
            Swal.fire({
                icon: 'success',
                title: 'Link copied!',
                text: 'Post link copied to clipboard',
                timer: 2000,
                showConfirmButton: false
            });
        });
    }
}

// Comment like functionality
document.addEventListener('click', function(e) {
    const likeBtn = e.target.closest('.like-comment-btn');
    if (likeBtn) {
        e.preventDefault();
        e.stopPropagation();
        
        const btn = likeBtn;
        const commentId = btn.getAttribute('data-comment-id');
        const likesCountSpan = btn.querySelector('.comment-likes-count');
        const actionText = btn.querySelector('.action-text');
        const loginUrl = '{{ url_for('public.login', next=request.url) }}';
        
        fetch(`/comment/${commentId}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (response.status === 401) {
                return response.json().then(data => {
                    if (data.redirect) {
                        redirectToLogin(data.redirect);
                    } else if (loginUrl) {
                        redirectToLogin(loginUrl);
                    } else {
                        redirectToLogin('/login');
                    }
                    throw new Error('Unauthorized');
                });
            }
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data && data.success) {
                // Update likes count
                const likesCount = data.likes_count || 0;
                if (likesCount > 0) {
                    if (!likesCountSpan) {
                        const span = document.createElement('span');
                        span.className = 'comment-likes-count';
                        btn.appendChild(span);
                    }
                    const countSpan = btn.querySelector('.comment-likes-count');
                    if (countSpan) {
                        countSpan.textContent = ' 路 ' + likesCount;
                    }
                } else {
                    if (likesCountSpan) {
                        likesCountSpan.remove();
                    }
                }
                
                // Update button state
                if (data.liked) {
                    btn.classList.add('liked');
                    if (actionText) {
                        actionText.textContent = 'Liked';
                    }
                } else {
                    btn.classList.remove('liked');
                    if (actionText) {
                        actionText.textContent = 'Like';
                    }
                }
            } else {
                console.error('Unexpected response:', data);
            }
        })
        .catch(error => {
            console.error('Error liking comment:', error);
        });
    }
});

// Reply button functionality
document.addEventListener('click', function(e) {
    const replyBtn = e.target.closest('.reply-btn');
    if (replyBtn) {
        e.preventDefault();
        e.stopPropagation();
        
        {% if not current_user.is_authenticated or session.get('user_type') != 'user' %}
        const loginUrl = replyBtn.getAttribute('data-login-url');
        redirectToLogin(loginUrl);
        return;
        {% endif %}
        
        const commentId = replyBtn.getAttribute('data-comment-id');
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        
        // Hide all other reply forms
        document.querySelectorAll('.reply-form-container').forEach(form => {
            if (form.id !== `reply-form-${commentId}`) {
                form.style.display = 'none';
                const textarea = form.querySelector('textarea[name="comment"]');
                if (textarea) {
                    textarea.value = '';
                    textarea.rows = 1;
                }
            }
        });
        
        // Toggle current reply form
        if (replyForm) {
            const isHidden = replyForm.style.display === 'none' || !replyForm.style.display;
            
            if (isHidden) {
                replyForm.style.display = 'block';
                const textarea = replyForm.querySelector('textarea[name="comment"]');
                if (textarea) {
                    textarea.focus();
                    textarea.rows = 2;
                }
            } else {
                replyForm.style.display = 'none';
                const textarea = replyForm.querySelector('textarea[name="comment"]');
                if (textarea) {
                    textarea.value = '';
                    textarea.rows = 1;
                }
            }
        }
    }
    
    // Cancel reply button
    const cancelBtn = e.target.closest('.cancel-reply-btn');
    if (cancelBtn) {
        e.preventDefault();
        e.stopPropagation();
        
        const commentId = cancelBtn.getAttribute('data-comment-id');
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        
        if (replyForm) {
            replyForm.style.display = 'none';
            const textarea = replyForm.querySelector('textarea[name="comment"]');
            if (textarea) {
                textarea.value = '';
                textarea.rows = 1;
            }
        }
    }
});


// Show more replies (for initially hidden replies)
function showMoreReplies(commentId) {
    const hiddenContainer = document.getElementById(`hidden-replies-${commentId}`);
    const viewMoreBtn = document.getElementById(`view-more-btn-${commentId}`);
    const repliesContainer = document.getElementById(`replies-${commentId}`);
    
    if (hiddenContainer && repliesContainer) {
        // Move hidden replies into the main replies container
        while (hiddenContainer.firstChild) {
            repliesContainer.appendChild(hiddenContainer.firstChild);
        }
        hiddenContainer.remove();
    }
    if (viewMoreBtn) {
        viewMoreBtn.style.display = 'none';
    }
}

// Load replies via AJAX (for deeply nested comments)
function loadRepliesAjax(commentId) {
    const btn = document.querySelector(`.load-more-ajax[data-comment-id="${commentId}"]`);
    if (!btn) return;
    
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    btn.style.pointerEvents = 'none';
    
    fetch(`/api/comment/${commentId}/replies?max_depth=5`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to load replies');
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.replies && data.replies.length > 0) {
            // Get the wrapper container
            const wrapper = btn.parentElement;
            
            // Create replies container with thread line
            const repliesContainer = document.createElement('div');
            repliesContainer.className = 'replies-container';
            repliesContainer.id = `replies-${commentId}`;
            
            // Render each reply
            data.replies.forEach(reply => {
                repliesContainer.insertAdjacentHTML('beforeend', renderCommentHtml(reply, 1));
            });
            
            // Replace button with replies
            btn.remove();
            wrapper.appendChild(repliesContainer);
        }
    })
    .catch(error => {
        console.error('Error loading replies:', error);
        btn.innerHTML = originalText;
        btn.style.pointerEvents = 'auto';
    });
}

// Render comment HTML from JSON (Facebook-style structure)
function renderCommentHtml(comment, depth = 0) {
    const isLiked = comment.is_liked;
    const hasReplies = comment.replies && comment.replies.length > 0;
    const isReply = comment.parent_comment_id !== null;
    
    let repliesHtml = '';
    if (hasReplies) {
        repliesHtml = `
        <div class="replies-wrapper">
            <div class="replies-container">
                ${comment.replies.map(reply => renderCommentHtml(reply, depth + 1)).join('')}
            </div>
        </div>`;
    }
    
    return `
    <div class="fb-comment-item ${isReply ? 'fb-comment-reply' : ''}" 
         data-comment-id="${comment.id}" 
         data-depth="${depth}"
         data-parent-id="${comment.parent_comment_id || ''}">
        <div class="comment-row">
            <div class="comment-avatar">
                <div class="avatar-circle ${isReply ? 'avatar-reply' : 'avatar-parent'}">
                    <span class="avatar-text">${getInitials(comment.author)}</span>
                </div>
            </div>
            <div class="comment-body">
                <div class="comment-bubble ${isReply ? 'comment-bubble-reply' : ''}">
                    <div class="comment-header">
                        <span class="comment-author">${escapeHtml(comment.author)}</span>
                    </div>
                    ${comment.content ? `<div class="comment-text">${escapeHtml(comment.content)}</div>` : ''}
                    ${comment.image ? `
                    <div class="comment-image-container">
                        <img src="/static/uploads/${comment.image}" alt="Comment image" class="comment-image" onclick="openImageModal(this.src)">
                    </div>
                    ` : ''}
                </div>
                <div class="comment-actions-bar">
                    <button class="comment-action-link like-comment-btn ${isLiked ? 'liked' : ''}" data-comment-id="${comment.id}">
                        <span class="action-text">${isLiked ? 'Liked' : 'Like'}</span>
                        ${comment.likes_count > 0 ? `<span class="comment-likes-count"> 路 ${comment.likes_count}</span>` : ''}
                    </button>
                    <span class="action-separator">路</span>
                    <button class="comment-action-link reply-btn" 
                            data-comment-id="${comment.id}" 
                            data-comment-author="${escapeHtml(comment.author)}"
                            data-login-url="{{ url_for('public.login', next=request.url) }}">
                        Reply
                    </button>
                    <span class="action-separator">路</span>
                    <span class="comment-time">${formatTimeAgo(comment.created_at)}</span>
                </div>
            </div>
        </div>
        ${repliesHtml}
    </div>`;
}

// ============== Image Handling Functions ==============

// Preview image before upload
function previewImage(input, commentId, type = 'main') {
    const file = input.files[0];
    if (file) {
        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            Swal.fire({
                icon: 'warning',
                title: 'File Too Large',
                text: 'Image must be less than 5MB.',
                timer: 3000,
                showConfirmButton: false
            });
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            let previewId;
            if (type === 'reply') {
                previewId = `reply-image-preview-${commentId}`;
            } else {
                previewId = 'main-image-preview';
            }
            
            const preview = document.getElementById(previewId);
            if (preview) {
                preview.style.display = 'block';
                preview.querySelector('img').src = e.target.result;
            }
        };
        reader.readAsDataURL(file);
    }
}

// Remove image preview
function removeImagePreview(commentId, type = 'main') {
    let previewId, inputSelector;
    
    if (type === 'reply') {
        previewId = `reply-image-preview-${commentId}`;
        inputSelector = `#reply-form-${commentId} input[name="image"]`;
    } else {
        previewId = 'main-image-preview';
        inputSelector = '#main-comment-form input[name="image"]';
    }
    
    const preview = document.getElementById(previewId);
    if (preview) {
        preview.style.display = 'none';
        preview.querySelector('img').src = '';
    }
    
    const input = document.querySelector(inputSelector);
    if (input) {
        input.value = '';
    }
}

// Open image in modal
function openImageModal(src) {
    Swal.fire({
        imageUrl: src,
        imageAlt: 'Comment image',
        showConfirmButton: false,
        showCloseButton: true,
        width: 'auto',
        padding: '0',
        background: 'transparent',
        backdrop: 'rgba(0,0,0,0.9)'
    });
}

// Helper functions
function getInitials(name) {
    if (!name) return '?';
    const parts = name.trim().split(' ');
    if (parts.length >= 2) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }
    return name[0].toUpperCase();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTimeAgo(dateString) {
    if (!dateString) return 'just now';
    
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
    if (seconds < 604800) return Math.floor(seconds / 86400) + 'd';
    if (seconds < 2592000) return Math.floor(seconds / 604800) + 'w';
    if (seconds < 31536000) return Math.floor(seconds / 2592000) + 'mo';
    return Math.floor(seconds / 31536000) + 'y';
}

// ============== AJAX Comment Submission ==============

const postId = {{ post.id }};
const apiUrl = `/api/post/${postId}/comments`;

// Current user info for rendering new comments
const currentUser = {
    name: '{{ current_user.full_name or current_user.username if current_user.is_authenticated else "" }}',
    initials: '{{ get_avatar_initials(current_user.full_name or current_user.username) if current_user.is_authenticated else "?" }}'
};

// Submit comment via AJAX (supports both JSON and FormData for images)
async function submitCommentAjax(content, parentCommentId = null, imageFile = null) {
    try {
        let response;
        
        if (imageFile) {
            // Use FormData for image uploads
            const formData = new FormData();
            formData.append('content', content);
            if (parentCommentId) {
                formData.append('parent_comment_id', parentCommentId);
            }
            formData.append('image', imageFile);
            
            response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                credentials: 'same-origin',
                body: formData
            });
        } else {
            // Use JSON for text-only comments
            response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    content: content,
                    parent_comment_id: parentCommentId
                })
            });
        }
        
        const data = await response.json();
        
        if (response.status === 401) {
            // Not authenticated
            redirectToLogin(data.redirect || '{{ url_for("public.login") }}');
            return null;
        }
        
        if (!response.ok) {
            throw new Error(data.message || 'Failed to submit comment');
        }
        
        return data;
    } catch (error) {
        console.error('Error submitting comment:', error);
        throw error;
    }
}

// Render a new comment HTML (for AJAX-added comments)
function renderNewComment(comment, isReply = false) {
    const imageHtml = comment.image ? `
        <div class="comment-image-container">
            <img src="/static/uploads/${comment.image}" alt="Comment image" class="comment-image" onclick="openImageModal(this.src)">
        </div>
    ` : '';
    
    const replyFormHtml = `
        {% if current_user.is_authenticated and session.get('user_type') == 'user' %}
        <div class="reply-form-container" id="reply-form-${comment.id}" style="display: none;">
            <form class="reply-form ajax-reply-form" data-parent-id="${comment.id}" enctype="multipart/form-data">
                <input type="hidden" name="parent_comment_id" value="${comment.id}">
                <div class="reply-form-avatar">
                    <div class="avatar-circle avatar-reply">
                        <span class="avatar-text">${currentUser.initials}</span>
                    </div>
                </div>
                <div class="reply-form-input">
                    <div class="comment-input-wrapper">
                        <textarea name="comment" class="form-control comment-input comment-input-reply" 
                                  rows="1" placeholder="Write a reply..." maxlength="2000"></textarea>
                    </div>
                    <div class="comment-image-preview" id="reply-image-preview-${comment.id}" style="display: none;">
                        <img src="" alt="Preview" class="preview-img">
                        <button type="button" class="remove-image-btn" onclick="removeImagePreview(${comment.id}, 'reply')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="reply-form-actions">
                        <label class="btn btn-sm btn-outline-secondary image-upload-btn" title="Add image">
                            <i class="fas fa-image"></i>
                            <input type="file" name="image" accept="image/*" class="image-input" 
                                   onchange="previewImage(this, ${comment.id}, 'reply')" style="display: none;">
                        </label>
                        <button type="submit" class="btn btn-sm btn-primary btn-reply-submit">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-link cancel-reply-btn" 
                                data-comment-id="${comment.id}">Cancel</button>
                    </div>
                </div>
            </form>
        </div>
        {% endif %}
    `;
    
    return `
    <div class="fb-comment-item ${isReply ? 'fb-comment-reply' : ''} new-comment-animation" 
         data-comment-id="${comment.id}" 
         data-depth="${comment.depth || 0}"
         data-parent-id="${comment.parent_comment_id || ''}">
        <div class="comment-row">
            <div class="comment-avatar">
                <div class="avatar-circle ${isReply ? 'avatar-reply' : 'avatar-parent'}">
                    <span class="avatar-text">${getInitials(comment.author)}</span>
                </div>
            </div>
            <div class="comment-body">
                <div class="comment-bubble ${isReply ? 'comment-bubble-reply' : ''}">
                    <div class="comment-header">
                        <span class="comment-author">${escapeHtml(comment.author)}</span>
                    </div>
                    ${comment.content ? `<div class="comment-text">${escapeHtml(comment.content)}</div>` : ''}
                    ${imageHtml}
                </div>
                <div class="comment-actions-bar">
                    <button class="comment-action-link like-comment-btn" data-comment-id="${comment.id}">
                        <span class="action-text">Like</span>
                    </button>
                    <span class="action-separator">路</span>
                    <button class="comment-action-link reply-btn" 
                            data-comment-id="${comment.id}" 
                            data-comment-author="${escapeHtml(comment.author)}"
                            data-login-url="{{ url_for('public.login', next=request.url) }}">
                        Reply
                    </button>
                    <span class="action-separator">路</span>
                    <span class="comment-time">just now</span>
                </div>
                ${replyFormHtml}
            </div>
        </div>
    </div>`;
}

// Update comments count display
function updateCommentsCount(increment = 1) {
    const countText = document.getElementById('commentsCountText');
    if (countText) {
        // Extract current count
        const text = countText.textContent;
        let count = 0;
        const match = text.match(/(\d+)/);
        if (match) {
            count = parseInt(match[1]);
        }
        count += increment;
        
        if (count === 0) {
            countText.textContent = 'No comments yet';
        } else if (count === 1) {
            countText.textContent = '1 comment';
        } else {
            countText.textContent = `${count} comments`;
        }
    }
}

// Handle main comment form submission
document.addEventListener('DOMContentLoaded', function() {
    const mainCommentForm = document.querySelector('.comment-form form');
    
    if (mainCommentForm) {
        mainCommentForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const textarea = this.querySelector('textarea[name="comment"]');
            const submitBtn = this.querySelector('button[type="submit"]');
            const imageInput = this.querySelector('input[name="image"]');
            const content = textarea.value.trim();
            const imageFile = imageInput && imageInput.files[0] ? imageInput.files[0] : null;
            
            if (!content && !imageFile) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Empty Comment',
                    text: 'Please write something or add an image before posting.',
                    timer: 2000,
                    showConfirmButton: false
                });
                return;
            }
            
            // Disable form while submitting
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
            textarea.disabled = true;
            
            try {
                const result = await submitCommentAjax(content, null, imageFile);
                
                if (result && result.success) {
                    // Clear form
                    textarea.value = '';
                    textarea.rows = 1;
                    if (imageInput) imageInput.value = '';
                    removeImagePreview('main');
                    const actions = this.querySelector('.comment-actions');
                    if (actions) actions.style.display = 'none';
                    
                    // Add new comment to the top of comments container
                    const commentsContainer = document.getElementById('comments-container');
                    const noCommentsMsg = commentsContainer.querySelector('p.text-muted');
                    if (noCommentsMsg) {
                        noCommentsMsg.remove();
                    }
                    
                    const newCommentHtml = renderNewComment(result.comment, false);
                    commentsContainer.insertAdjacentHTML('afterbegin', newCommentHtml);
                    
                    // Update count
                    updateCommentsCount(1);
                    
                    // Show success toast
                    Swal.fire({
                        icon: 'success',
                        title: 'Comment Posted!',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Failed to post comment. Please try again.'
                });
            } finally {
                // Re-enable form
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                textarea.disabled = false;
            }
        });
    }
});

// ============== Delete Comment Functionality ==============

// Delete comment via AJAX
async function deleteCommentAjax(commentId) {
    try {
        const response = await fetch(`/api/comment/${commentId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (response.status === 401) {
            redirectToLogin(data.redirect || '{{ url_for("public.login") }}');
            return null;
        }
        
        if (!response.ok) {
            throw new Error(data.message || 'Failed to delete comment');
        }
        
        return data;
    } catch (error) {
        console.error('Error deleting comment:', error);
        throw error;
    }
}

// Handle delete button clicks
document.addEventListener('click', async function(e) {
    const deleteBtn = e.target.closest('.delete-comment-btn');
    if (deleteBtn) {
        e.preventDefault();
        e.stopPropagation();
        
        const commentId = deleteBtn.getAttribute('data-comment-id');
        const hasReplies = deleteBtn.getAttribute('data-has-replies') === 'true';
        
        // Show confirmation dialog
        const confirmMessage = hasReplies 
            ? 'This comment has replies. Deleting it will also delete all replies. Are you sure?'
            : 'Are you sure you want to delete this comment?';
        
        const result = await Swal.fire({
            title: 'Delete Comment?',
            text: confirmMessage,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        });
        
        if (result.isConfirmed) {
            try {
                const response = await deleteCommentAjax(commentId);
                
                if (response && response.success) {
                    // Remove the comment from DOM
                    const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
                    if (commentElement) {
                        // Add fade out animation
                        commentElement.style.transition = 'opacity 0.3s, transform 0.3s';
                        commentElement.style.opacity = '0';
                        commentElement.style.transform = 'translateX(-20px)';
                        
                        setTimeout(() => {
                            // Check if this comment's parent has other replies
                            const parentWrapper = commentElement.closest('.replies-wrapper');
                            commentElement.remove();
                            
                            // If the replies container is now empty, remove it
                            if (parentWrapper) {
                                const repliesContainer = parentWrapper.querySelector('.replies-container');
                                if (repliesContainer && repliesContainer.children.length === 0) {
                                    parentWrapper.remove();
                                }
                            }
                        }, 300);
                    }
                    
                    // Update comment count
                    updateCommentsCount(-response.deleted_count);
                    
                    // Show success toast
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: response.deleted_count > 1 
                            ? `${response.deleted_count} comments deleted.`
                            : 'Comment deleted.',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Failed to delete comment. Please try again.'
                });
            }
        }
    }
});

// ============== Edit Comment Functionality ==============

// Edit comment via AJAX
async function editCommentAjax(commentId, content) {
    try {
        const response = await fetch(`/api/comment/${commentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ content: content })
        });
        
        const data = await response.json();
        
        if (response.status === 401) {
            redirectToLogin(data.redirect || '{{ url_for("public.login") }}');
            return null;
        }
        
        if (!response.ok) {
            throw new Error(data.message || 'Failed to edit comment');
        }
        
        return data;
    } catch (error) {
        console.error('Error editing comment:', error);
        throw error;
    }
}

// Handle edit button clicks
document.addEventListener('click', function(e) {
    const editBtn = e.target.closest('.edit-comment-btn');
    if (editBtn) {
        e.preventDefault();
        e.stopPropagation();
        
        const commentId = editBtn.getAttribute('data-comment-id');
        const editForm = document.getElementById(`edit-form-${commentId}`);
        const commentBubble = editBtn.closest('.comment-body').querySelector('.comment-bubble');
        
        // Hide all other edit forms
        document.querySelectorAll('.edit-form-container').forEach(form => {
            if (form.id !== `edit-form-${commentId}`) {
                form.style.display = 'none';
                // Show the comment bubble again
                const bubble = form.closest('.comment-body').querySelector('.comment-bubble');
                if (bubble) bubble.style.display = 'inline-block';
            }
        });
        
        // Toggle edit form
        if (editForm) {
            const isHidden = editForm.style.display === 'none' || !editForm.style.display;
            
            if (isHidden) {
                editForm.style.display = 'block';
                if (commentBubble) commentBubble.style.display = 'none';
                const textarea = editForm.querySelector('textarea');
                if (textarea) {
                    textarea.focus();
                    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                }
            } else {
                editForm.style.display = 'none';
                if (commentBubble) commentBubble.style.display = 'inline-block';
            }
        }
    }
    
    // Cancel edit button
    const cancelEditBtn = e.target.closest('.cancel-edit-btn');
    if (cancelEditBtn) {
        e.preventDefault();
        e.stopPropagation();
        
        const commentId = cancelEditBtn.getAttribute('data-comment-id');
        const editForm = document.getElementById(`edit-form-${commentId}`);
        const commentBody = cancelEditBtn.closest('.comment-body');
        const commentBubble = commentBody.querySelector('.comment-bubble');
        
        if (editForm) {
            editForm.style.display = 'none';
            // Reset textarea to original content
            const textarea = editForm.querySelector('textarea');
            const originalContent = commentBubble.querySelector('.comment-text').textContent;
            if (textarea) textarea.value = originalContent;
        }
        if (commentBubble) commentBubble.style.display = 'inline-block';
    }
});

// Handle edit form submissions
document.addEventListener('submit', async function(e) {
    const form = e.target;
    
    if (form.classList.contains('edit-form')) {
        e.preventDefault();
        
        const commentId = form.getAttribute('data-comment-id');
        const textarea = form.querySelector('textarea[name="content"]');
        const submitBtn = form.querySelector('button[type="submit"]');
        const content = textarea.value.trim();
        
        if (!content) {
            Swal.fire({
                icon: 'warning',
                title: 'Empty Comment',
                text: 'Comment cannot be empty.',
                timer: 2000,
                showConfirmButton: false
            });
            return;
        }
        
        // Disable form while submitting
        const originalBtnHtml = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        textarea.disabled = true;
        
        try {
            const result = await editCommentAjax(commentId, content);
            
            if (result && result.success) {
                // Update the comment text in the DOM
                const commentBody = form.closest('.comment-body');
                const commentBubble = commentBody.querySelector('.comment-bubble');
                const commentText = commentBubble.querySelector('.comment-text');
                
                if (commentText) {
                    commentText.textContent = result.comment.content;
                }
                
                // Hide edit form and show bubble
                form.closest('.edit-form-container').style.display = 'none';
                commentBubble.style.display = 'inline-block';
                
                // Show success toast
                Swal.fire({
                    icon: 'success',
                    title: 'Comment Updated!',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Failed to update comment. Please try again.'
            });
        } finally {
            // Re-enable form
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnHtml;
            textarea.disabled = false;
        }
    }
});

// Handle reply form submissions (using event delegation for dynamically added forms)
document.addEventListener('submit', async function(e) {
    const form = e.target;
    
    // Check if it's a reply form (either static or AJAX-added)
    if (form.classList.contains('reply-form') || form.classList.contains('ajax-reply-form')) {
        e.preventDefault();
        
        const textarea = form.querySelector('textarea[name="comment"]');
        const submitBtn = form.querySelector('button[type="submit"]');
        const parentIdInput = form.querySelector('input[name="parent_comment_id"]');
        const imageInput = form.querySelector('input[name="image"]');
        
        const content = textarea.value.trim();
        const parentCommentId = parentIdInput ? parentIdInput.value : null;
        const imageFile = imageInput && imageInput.files[0] ? imageInput.files[0] : null;
        
        if (!content && !imageFile) {
            Swal.fire({
                icon: 'warning',
                title: 'Empty Reply',
                text: 'Please write something or add an image before posting.',
                timer: 2000,
                showConfirmButton: false
            });
            return;
        }
        
        // Disable form while submitting
        const originalBtnHtml = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        textarea.disabled = true;
        
        try {
            const result = await submitCommentAjax(content, parentCommentId, imageFile);
            
            if (result && result.success) {
                // Clear and hide the reply form
                textarea.value = '';
                textarea.rows = 1;
                if (imageInput) imageInput.value = '';
                if (parentCommentId) removeImagePreview(parentCommentId, 'reply');
                const formContainer = form.closest('.reply-form-container');
                if (formContainer) {
                    formContainer.style.display = 'none';
                }
                
                // Find where to insert the reply
                const parentComment = document.querySelector(`[data-comment-id="${parentCommentId}"]`);
                if (parentComment) {
                    // Check if replies wrapper exists
                    let repliesWrapper = parentComment.querySelector(':scope > .replies-wrapper');
                    let repliesContainer;
                    
                    if (!repliesWrapper) {
                        // Create replies wrapper and container
                        repliesWrapper = document.createElement('div');
                        repliesWrapper.className = 'replies-wrapper';
                        repliesWrapper.id = `replies-wrapper-${parentCommentId}`;
                        
                        repliesContainer = document.createElement('div');
                        repliesContainer.className = 'replies-container';
                        repliesContainer.id = `replies-${parentCommentId}`;
                        
                        repliesWrapper.appendChild(repliesContainer);
                        parentComment.appendChild(repliesWrapper);
                    } else {
                        repliesContainer = repliesWrapper.querySelector('.replies-container');
                        if (!repliesContainer) {
                            repliesContainer = document.createElement('div');
                            repliesContainer.className = 'replies-container';
                            repliesContainer.id = `replies-${parentCommentId}`;
                            repliesWrapper.insertBefore(repliesContainer, repliesWrapper.firstChild);
                        }
                    }
                    
                    // Add the new reply
                    const newReplyHtml = renderNewComment(result.comment, true);
                    repliesContainer.insertAdjacentHTML('beforeend', newReplyHtml);
                    
                    // Update count
                    updateCommentsCount(1);
                    
                    // Scroll to new reply
                    const newReply = repliesContainer.lastElementChild;
                    if (newReply) {
                        newReply.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                
                // Show success toast
                Swal.fire({
                    icon: 'success',
                    title: 'Reply Posted!',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Failed to post reply. Please try again.'
            });
        } finally {
            // Re-enable form
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnHtml;
            textarea.disabled = false;
        }
    }
});
</script>
{% endblock %}
