{% extends "admin/base.html" %} {% block title %}{{ title }}{% endblock %} {%
block extra_css %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
{% endblock %} {% block content %}
<div class="container-fluid mt-4">
  <h1 class="mb-4">
    <i class="fas fa-{{ 'plus' if not post else 'edit' }}"></i> {{ title }}
  </h1>

  <form method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}

    <div class="row">
      <div class="col-md-8">
        <div class="card mb-3">
          <div class="card-body">
            <div class="mb-3">
              {{ form.title.label(class="form-label") }} {{
              form.title(class="form-control") }} {% if form.title.errors %}
              <div class="text-danger">
                {% for error in form.title.errors %}
                <small>{{ error }}</small>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            <div class="mb-3">
              {{ form.content.label(class="form-label") }}
              <div id="editor" style="height: 400px"></div>
              {{ form.content(id="content", style="display:none;") }} {% if
              form.content.errors %}
              <div class="text-danger">
                {% for error in form.content.errors %}
                <small>{{ error }}</small>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card mb-3">
          <div class="card-header">
            <h5>Publish</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              {{ form.is_published(class="form-check-input") }} {{
              form.is_published.label(class="form-check-label") }}
            </div>
            {{ form.submit(class="btn btn-primary w-100") }}
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header">
            <h5>Thumbnail</h5>
          </div>
          <div class="card-body">
            {% if post and post.thumbnail %}
            <img
              src="{{ url_for('static', filename='uploads/' + post.thumbnail) }}"
              class="img-fluid mb-2"
              alt="Current thumbnail"
            />
            {% endif %} {{ form.thumbnail(class="form-control") }} {% if
            form.thumbnail.errors %}
            <div class="text-danger">
              {% for error in form.thumbnail.errors %}
              <small>{{ error }}</small>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header">
            <h5>Category</h5>
          </div>
          <div class="card-body">{{ form.category(class="form-select") }}</div>
        </div>

        <div class="card mb-3">
          <div class="card-header">
            <h5>Tags</h5>
          </div>
          <div class="card-body">
            {{ form.tags(class="form-select", size="5", multiple=True) }}
            <small class="text-muted"
              >Hold Ctrl/Cmd to select multiple tags</small
            >
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
{% endblock %} {% block extra_js %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
  var quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
          toolbar: [
              [{ 'header': [1, 2, 3, false] }],
              ['bold', 'italic', 'underline', 'strike'],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              ['blockquote', 'code-block'],
              ['link', 'image'],
              [{ 'color': [] }, { 'background': [] }],
              ['clean']
          ]
      }
  });

  // Keep hidden textarea in sync with Quill so browser validation doesn't block submit
  const hiddenContentField = document.getElementById('content');

  // Set initial content if editing
  {% if post %}
  quill.root.innerHTML = {{ post.content|tojson|safe }};
  {% endif %}

  const syncContent = () => {
      hiddenContentField.value = quill.root.innerHTML;
  };

  // Sync on load and on any editor change
  syncContent();
  quill.on('text-change', syncContent);

  // Final sync right before submit
  document.querySelector('form').addEventListener('submit', function() {
      syncContent();
  });
</script>
{% endblock %}
